<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nest Ticket Queue - Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .notification-log {
      max-height: 300px;
      overflow-y: auto;
    }
    .event-card {
      transition: box-shadow 0.2s;
    }
    .event-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <section class="section">
    <div class="container">
      <h1 class="title has-text-centered">ğŸ« Nest Ticket Queue Demo</h1>
      <p class="subtitle has-text-centered has-text-grey">ì‹¤ì‹œê°„ í‹°ì¼“ ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ</p>

      <div class="columns">
        <div class="column is-8 is-offset-2">

          <!-- Login Section -->
          <div class="box" id="login-section">
            <h2 class="title is-5">ğŸ” ë¡œê·¸ì¸</h2>
            <div class="field">
              <label class="label">ì´ë©”ì¼</label>
              <div class="control">
                <input class="input" type="email" id="email" placeholder="user1@test.com" value="user1@test.com">
              </div>
            </div>
            <div class="field">
              <label class="label">ë¹„ë°€ë²ˆí˜¸</label>
              <div class="control">
                <input class="input" type="password" id="password" placeholder="password123" value="password123">
              </div>
            </div>
            <div class="field">
              <div class="control">
                <button class="button is-primary" onclick="login()">ë¡œê·¸ì¸</button>
              </div>
            </div>
            <p id="login-status"></p>
          </div>

          <!-- Events Section -->
          <div class="box" id="events-section" style="display:none;">
            <div class="level">
              <div class="level-left">
                <h2 class="title is-5 mb-0">ğŸ“… ì´ë²¤íŠ¸ ëª©ë¡</h2>
              </div>
              <div class="level-right">
                <button class="button is-small is-light" onclick="loadEvents()">ìƒˆë¡œê³ ì¹¨</button>
              </div>
            </div>
            <hr>
            <div id="events-list"></div>
          </div>

          <!-- Queue Section -->
          <div class="box" id="queue-section" style="display:none;">
            <h2 class="title is-5">â³ ëŒ€ê¸°ì—´ ìƒíƒœ</h2>
            <table class="table is-fullwidth">
              <tbody>
                <tr>
                  <th>ì´ë²¤íŠ¸</th>
                  <td id="queue-event-name">-</td>
                </tr>
                <tr>
                  <th>ìƒíƒœ</th>
                  <td><span id="queue-status" class="tag">-</span></td>
                </tr>
                <tr>
                  <th>ëŒ€ê¸° ìˆœë²ˆ</th>
                  <td id="queue-position">-</td>
                </tr>
                <tr>
                  <th>ë‚¨ì€ ì‹œê°„</th>
                  <td id="queue-expires">-</td>
                </tr>
              </tbody>
            </table>
            <button class="button is-info is-light" onclick="checkQueueStatus()">ìƒíƒœ í™•ì¸</button>
          </div>

          <!-- Reservation Section -->
          <div class="box" id="reservation-section" style="display:none;">
            <h2 class="title is-5">ğŸŸï¸ ì˜ˆì•½ ì •ë³´</h2>
            <table class="table is-fullwidth">
              <tbody>
                <tr>
                  <th>ì˜ˆì•½ ID</th>
                  <td><code id="reservation-id">-</code></td>
                </tr>
                <tr>
                  <th>ìƒíƒœ</th>
                  <td><span id="reservation-status" class="tag">-</span></td>
                </tr>
                <tr>
                  <th>ë§Œë£Œ ì‹œê°„</th>
                  <td id="reservation-expires">-</td>
                </tr>
              </tbody>
            </table>
            <button class="button is-success" id="pay-btn" onclick="processPayment()">ğŸ’³ ê²°ì œí•˜ê¸°</button>
          </div>

          <!-- Notifications Log -->
          <div class="box">
            <div class="level">
              <div class="level-left">
                <h2 class="title is-5 mb-0">ğŸ“¢ ì‹¤ì‹œê°„ ì•Œë¦¼</h2>
              </div>
              <div class="level-right">
                <span id="ws-status" class="tag is-light">ì—°ê²° ì•ˆë¨</span>
              </div>
            </div>
            <hr>
            <div id="notifications" class="notification-log content is-small"></div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <script>
    let token = null;
    let socket = null;
    let currentEventId = null;
    let currentReservationId = null;
    let expirationTimer = null;
    const API_BASE = '';

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `notification is-${type} is-light`;
      el.textContent = message;
      el.style.display = 'block';
    }

    function addNotification(message, type = 'info') {
      const container = document.getElementById('notifications');
      const time = new Date().toLocaleTimeString();
      const colorMap = { info: 'info', queue: 'warning', active: 'success', reservation: 'link', error: 'danger' };
      const color = colorMap[type] || 'info';
      container.innerHTML = `<p><span class="tag is-${color} is-light mr-2">${time}</span>${message}</p>` + container.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleString('ko-KR');
    }

    function updateCountdown(expiresAt) {
      if (expirationTimer) clearInterval(expirationTimer);
      const updateTimer = () => {
        const diff = new Date(expiresAt) - new Date();
        if (diff <= 0) {
          document.getElementById('queue-expires').textContent = 'ë§Œë£Œë¨';
          document.getElementById('reservation-expires').textContent = 'ë§Œë£Œë¨';
          clearInterval(expirationTimer);
          return;
        }
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        const timeStr = `${minutes}ë¶„ ${seconds}ì´ˆ`;
        document.getElementById('queue-expires').textContent = timeStr;
        document.getElementById('reservation-expires').textContent = timeStr;
      };
      updateTimer();
      expirationTimer = setInterval(updateTimer, 1000);
    }

    async function apiCall(method, path, body = null) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      const response = await fetch(`${API_BASE}${path}`, options);
      const data = await response.json();
      if (!response.ok) throw new Error(data.message || 'API Error');
      return data;
    }

    async function login() {
      try {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const data = await apiCall('POST', '/auth/login', { email, password });
        token = data.accessToken;
        showStatus('login-status', 'âœ… ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
        document.getElementById('events-section').style.display = 'block';
        connectWebSocket();
        loadEvents();
      } catch (error) {
        showStatus('login-status', `âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'danger');
      }
    }

    function connectWebSocket() {
      if (socket) socket.disconnect();
      socket = io({ auth: { token } });

      socket.on('connect', () => {
        document.getElementById('ws-status').className = 'tag is-success';
        document.getElementById('ws-status').textContent = 'ì—°ê²°ë¨';
        addNotification('WebSocket ì—°ê²°ë¨', 'active');
      });

      socket.on('disconnect', () => {
        document.getElementById('ws-status').className = 'tag is-danger';
        document.getElementById('ws-status').textContent = 'ì—°ê²° ëŠê¹€';
        addNotification('WebSocket ì—°ê²° ëŠê¹€', 'error');
      });

      socket.on('queue:position', (data) => {
        addNotification(`ëŒ€ê¸° ìˆœë²ˆ ì—…ë°ì´íŠ¸: ${data.position}ë²ˆ`, 'queue');
        document.getElementById('queue-position').textContent = data.position;
      });

      socket.on('queue:active', (data) => {
        addNotification(`ğŸ‰ ì°¨ë¡€ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤! ì˜ˆì•½ ID: ${data.reservationId}`, 'active');
        document.getElementById('queue-status').textContent = 'ACTIVE';
        document.getElementById('queue-status').className = 'tag is-success';
        if (data.reservationId) {
          currentReservationId = data.reservationId;
          document.getElementById('reservation-section').style.display = 'block';
          document.getElementById('reservation-id').textContent = data.reservationId;
          document.getElementById('reservation-status').textContent = 'PENDING_PAYMENT';
          document.getElementById('reservation-status').className = 'tag is-warning';
          if (data.expiresAt) updateCountdown(data.expiresAt);
        }
      });

      socket.on('queue:soldout', () => {
        addNotification('ğŸ˜¢ ë§¤ì§„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
        document.getElementById('queue-status').textContent = 'EXPIRED (ë§¤ì§„)';
        document.getElementById('queue-status').className = 'tag is-danger';
      });

      socket.on('reservation:expired', (data) => {
        addNotification(`â° ì˜ˆì•½ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤: ${data.reservationId}`, 'error');
        document.getElementById('reservation-status').textContent = 'EXPIRED';
        document.getElementById('reservation-status').className = 'tag is-danger';
        document.getElementById('pay-btn').disabled = true;
      });

      socket.on('reservation:paid', (data) => {
        addNotification(`âœ… ê²°ì œ ì™„ë£Œ! ì˜ˆì•½ ID: ${data.reservationId}`, 'reservation');
        document.getElementById('reservation-status').textContent = 'PAID';
        document.getElementById('reservation-status').className = 'tag is-success';
        document.getElementById('pay-btn').disabled = true;
        document.getElementById('pay-btn').textContent = 'ê²°ì œ ì™„ë£Œ âœ“';
        if (expirationTimer) clearInterval(expirationTimer);
      });
    }

    async function loadEvents() {
      try {
        const events = await apiCall('GET', '/events');
        const container = document.getElementById('events-list');
        if (events.length === 0) {
          container.innerHTML = '<p class="has-text-grey">ë“±ë¡ëœ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        container.innerHTML = events.map(event => `
          <div class="box event-card">
            <div class="level is-mobile">
              <div class="level-left">
                <div>
                  <p class="title is-6">${event.name}</p>
                  <p class="subtitle is-7 has-text-grey">
                    ğŸ« ${event.remainingSeats ?? '?'}/${event.totalSeats}ì„ ë‚¨ìŒ
                  </p>
                </div>
              </div>
              <div class="level-right">
                <button class="button is-primary is-small" onclick="joinQueue('${event.id}', '${event.name}')">
                  ì°¸ê°€
                </button>
              </div>
            </div>
            <p class="is-size-7 has-text-grey">
              ğŸ“… ${formatDate(event.salesStartAt)} ~ ${formatDate(event.salesEndAt)}
            </p>
          </div>
        `).join('');
      } catch (error) {
        addNotification(`ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    async function joinQueue(eventId, eventName) {
      try {
        currentEventId = eventId;
        const data = await apiCall('POST', `/events/${eventId}/queue/join`);
        document.getElementById('queue-section').style.display = 'block';
        document.getElementById('queue-event-name').textContent = eventName;
        document.getElementById('queue-status').textContent = data.status || 'WAITING';
        document.getElementById('queue-status').className = `tag is-${data.status === 'ACTIVE' ? 'success' : 'warning'}`;
        document.getElementById('queue-position').textContent = data.position;
        addNotification(`ëŒ€ê¸°ì—´ ì°¸ê°€ ì™„ë£Œ! ìˆœë²ˆ: ${data.position}`, 'queue');
        if (data.status === 'ACTIVE' && data.reservationId) {
          currentReservationId = data.reservationId;
          document.getElementById('reservation-section').style.display = 'block';
          document.getElementById('reservation-id').textContent = data.reservationId;
          document.getElementById('reservation-status').textContent = 'PENDING_PAYMENT';
          document.getElementById('reservation-status').className = 'tag is-warning';
          if (data.expiresAt) updateCountdown(data.expiresAt);
        }
      } catch (error) {
        addNotification(`ëŒ€ê¸°ì—´ ì°¸ê°€ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    async function checkQueueStatus() {
      if (!currentEventId) {
        addNotification('ë¨¼ì € ì´ë²¤íŠ¸ì— ì°¸ê°€í•˜ì„¸ìš”.', 'error');
        return;
      }
      try {
        const data = await apiCall('GET', `/events/${currentEventId}/queue/me`);
        document.getElementById('queue-status').textContent = data.status;
        document.getElementById('queue-status').className = `tag is-${data.status === 'ACTIVE' ? 'success' : data.status === 'DONE' ? 'info' : 'warning'}`;
        document.getElementById('queue-position').textContent = data.position ?? '-';
        if (data.expiresAt) updateCountdown(data.expiresAt);
        if (data.status === 'ACTIVE' && data.reservationId) {
          currentReservationId = data.reservationId;
          document.getElementById('reservation-section').style.display = 'block';
          document.getElementById('reservation-id').textContent = data.reservationId;
          document.getElementById('reservation-status').textContent = data.reservationStatus || 'PENDING_PAYMENT';
        }
        addNotification(`ìƒíƒœ í™•ì¸: ${data.status}, ìˆœë²ˆ: ${data.position ?? '-'}`, 'queue');
      } catch (error) {
        addNotification(`ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    async function processPayment() {
      if (!currentReservationId) {
        addNotification('ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      try {
        await apiCall('POST', `/reservations/${currentReservationId}/pay`);
        document.getElementById('reservation-status').textContent = 'PAID';
        document.getElementById('reservation-status').className = 'tag is-success';
        document.getElementById('pay-btn').disabled = true;
        document.getElementById('pay-btn').textContent = 'ê²°ì œ ì™„ë£Œ âœ“';
        if (expirationTimer) clearInterval(expirationTimer);
        document.getElementById('queue-expires').textContent = '-';
        document.getElementById('reservation-expires').textContent = '-';
        addNotification('ğŸ‰ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'reservation');
      } catch (error) {
        addNotification(`ê²°ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
